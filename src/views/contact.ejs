<%- include('layouts/header', {path: '/contact'}) %>

<!-- Contact Form Section -->
<div class="container mx-auto px-4 py-8">
  <h2 class="text-3xl font-bold text-gray-900 mb-8">Contact Us</h2>

  <div class="bg-white rounded-lg shadow-md p-6 max-w-2xl mx-auto">
    <div
      id="success-message"
      class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"
    >
      Thank you for your message! We'll get back to you soon.
    </div>

    <div
      id="error-message"
      class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"
    >
      There was an error submitting your message. Please try again.
    </div>

    <form id="contact-form">
      <div class="mb-4">
        <label for="name" class="block text-gray-700 font-medium mb-2"
          >Name</label
        >
        <input
          type="text"
          id="name"
          name="name"
          required
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
        />
      </div>

      <div class="mb-4">
        <label for="email" class="block text-gray-700 font-medium mb-2"
          >Email</label
        >
        <input
          type="email"
          id="email"
          name="email"
          required
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
        />
      </div>

      <div class="mb-4">
        <label for="phone" class="block text-gray-700 font-medium mb-2"
          >Mobile Number</label
        >
        <input
          type="tel"
          id="phone"
          name="phone"
          required
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
        />
      </div>

      <div class="mb-4">
        <label class="block text-gray-700 font-medium mb-2">Interested Product(s)</label>
        <div id="product-checkboxes" class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
          <!-- Checkboxes will be populated by JS -->
        </div>
      </div>

      <div class="mb-6">
        <label for="message" class="block text-gray-700 font-medium mb-2"
          >Message</label
        >
        <textarea
          id="message"
          name="message"
          rows="4"
          class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
        ></textarea>
      </div>

      <button
        type="submit"
        class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-300"
      >
        Submit
      </button>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    console.log('Contact page loaded');

    // Fetch products for checkboxes
    try {
      const response = await fetch('/api/products');
      const data = await response.json();
      if (data.success) {
        const checkboxContainer = document.getElementById('product-checkboxes');
        checkboxContainer.innerHTML = '';
        
        data.data.forEach((product) => {
          const checkboxDiv = document.createElement('div');
          checkboxDiv.className = 'flex items-center';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `product-${product._id}`;
          checkbox.name = 'productIds';
          checkbox.value = product._id;
          checkbox.className = 'mr-2 h-4 w-4 text-green-600 focus:ring-green-500';
          checkbox.dataset.name = product.name;
          
          const label = document.createElement('label');
          label.htmlFor = `product-${product._id}`;
          label.className = 'text-gray-700';
          label.textContent = product.name;
          
          checkboxDiv.appendChild(checkbox);
          checkboxDiv.appendChild(label);
          checkboxContainer.appendChild(checkboxDiv);
        });
        
        // Pre-select if sessionStorage has selectedProduct
        const selectedProductJson = sessionStorage.getItem('selectedProduct');
        if (selectedProductJson) {
          const selectedProduct = JSON.parse(selectedProductJson);
          const checkbox = document.getElementById(`product-${selectedProduct.id}`);
          if (checkbox) {
            checkbox.checked = true;
          }
        }
      }
    } catch (error) {
      console.error('Error loading products:', error);
    }

    // Handle form submission
    document
      .getElementById('contact-form')
      .addEventListener('submit', async (e) => {
        e.preventDefault();

        // Hide any previous messages
        document.getElementById('success-message').classList.add('hidden');
        document.getElementById('error-message').classList.add('hidden');

        // Get all checked checkboxes
        const checkedBoxes = document.querySelectorAll('input[name="productIds"]:checked');
        const productIds = Array.from(checkedBoxes).map(cb => cb.value);
        const productNames = Array.from(checkedBoxes).map(cb => cb.dataset.name);

        const formData = {
          name: document.getElementById('name').value,
          email: document.getElementById('email').value,
          phone: document.getElementById('phone').value,
          productIds,
          productNames,
          message: document.getElementById('message').value || '',
        };

        console.log('Submitting form data:', formData);

        try {
          const response = await fetch('/api/contact', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
          });

          if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
          }

          const data = await response.json();
          console.log('Server response:', data);

          if (data.success) {
            document
              .getElementById('success-message')
              .classList.remove('hidden');
            document.getElementById('contact-form').reset();
            sessionStorage.removeItem('selectedProduct');
          } else {
            document.getElementById('error-message').classList.remove('hidden');
            console.error('Form submission failed:', data.message);
          }
        } catch (error) {
          document.getElementById('error-message').classList.remove('hidden');
          console.error('Error submitting form:', error);
        }
      });
  });
</script>

<%- include('layouts/footer') %>